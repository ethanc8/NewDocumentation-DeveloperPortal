<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Sysprof" href="sysprof.html" /><link rel="prev" title="Valgrind" href="valgrind.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.05.06 -->
        <title>Massif - GNUstep Developer Portal</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=387cc868" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" /
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">GNUstep Developer Portal</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">GNUstep Developer Portal</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction.html">Platform Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Platform Introduction</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../introduction/components.html">Platform Components</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Platform Components</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/overview/libraries.html">Libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/overview/services.html">Services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/languages.html">Programming Languages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/builder.html">GNOME Builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/flatpak.html">Flatpak</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../guidelines.html">Guidelines</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Guidelines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../guidelines/programming.html">Programming Guidelines</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Programming Guidelines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/coding-style.html">C Coding Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/memory-management.html">Managing Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/writing-good-code.html">The Importance of Writing Good Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/optimizing.html">Optimizing GNOME Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/namespacing.html">Namespacing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/programming/introspection.html">Introspection</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../guidelines/accessibility.html">Accessibility</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Accessibility</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/accessibility/coding-guidelines.html">Coding Guidelines for Supporting Accessibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/accessibility/custom-widgets.html">Making Custom Components Accessible</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../guidelines/localization.html">Localization</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Localization</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/localization/practices.html">Best Practices for Localization</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../guidelines/maintainer.html">Maintainer Guidelines</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of Maintainer Guidelines</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/maintainer/api-stability.html">API Stability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/maintainer/parallel-installability.html">Parallel Installability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../guidelines/maintainer/integrating.html">Integrating with GNOME</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../guidelines/devel-docs.html">Developer Documentation Style Guidelines</a></li>
<li class="toctree-l2"><a class="reference external" href="https://developer.gnome.org/hig/">Human Interface Guidelines</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../tools.html">Tools</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Tools</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="inspector.html">GTK Inspector</a></li>
<li class="toctree-l2"><a class="reference internal" href="valgrind.html">Valgrind</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Massif</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysprof.html">Sysprof</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tools/massif.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="massif">
<h1>Massif<a class="headerlink" href="#massif" title="Permalink to this heading">¶</a></h1>
<p>Massif is a member of the Valgrind suite of memory-profiling tools. Its purpose
is to give a detailed view of dynamic memory usage during the lifetime of the
program. Specifically it records the memory use of the heap and the stack.</p>
<p>The heap is the region of memory which is allocated with functions like <code class="docutils literal notranslate"><span class="pre">malloc</span></code>.
It grows on demand and is usually the largest region of memory in a program. The
stack is where all the local data for functions is stored. This includes the
“automatic” variables in C and the return address for subroutines. The stack is
typically a lot smaller and a lot more active than the heap. We won’t consider
the stack explicitly since Massif treats it as though it were just another part
of the heap. Massif also gives information about how much memory is used to
manage the heap.</p>
<p>Massif produces two output files: a graphical overview in a postscript file and
a detailed breakdown in a text file.</p>
<section id="using-massif-with-gnome">
<h2>Using Massif with GNOME<a class="headerlink" href="#using-massif-with-gnome" title="Permalink to this heading">¶</a></h2>
<p>Massif has very few options and for many programs does not need them. However
for GNOME applications, where memory allocation might be buried deep in either
glib or GTK, the number of levels down the call-stack Massif descends needs to
be increased. This is achieved using the <code class="docutils literal notranslate"><span class="pre">--depth</span> <span class="pre">parameter</span></code>. By default this is
3; increasing it to 5 will guarantee the call-stack reaches down to your code.
One or two more levels may also be desirable to provide your code with some
context. Since the level of detail becomes quickly overwhelming it is best to
start with the smaller depth parameter and only increase it when it becomes
apparent that it isn’t sufficient.</p>
<p>It is also useful to tell Massif which functions allocate memory in GLib. It
removes an unnecessary layer of function calls from the reports and gives you a
clearer idea of what code is allocating memory. The allocating functions in GLib
are <code class="docutils literal notranslate"><span class="pre">g_malloc</span></code>, <code class="docutils literal notranslate"><span class="pre">g_malloc0</span></code>, <code class="docutils literal notranslate"><span class="pre">g_realloc</span></code>, <code class="docutils literal notranslate"><span class="pre">g_try_malloc</span></code>, and
<code class="docutils literal notranslate"><span class="pre">g_mem_chunk_alloc</span></code>. You use the <code class="docutils literal notranslate"><span class="pre">--alloc-fn</span></code> option to tell Massif about
them.</p>
<p>Your command-line should therefore look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">valgrind</span> <span class="o">--</span><span class="n">tool</span><span class="o">=</span><span class="n">massif</span> \
  <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">5</span> \
  <span class="o">--</span><span class="n">alloc</span><span class="o">-</span><span class="n">fn</span><span class="o">=</span><span class="n">g_malloc</span> \
  <span class="o">--</span><span class="n">alloc</span><span class="o">-</span><span class="n">fn</span><span class="o">=</span><span class="n">g_realloc</span> \
  <span class="o">--</span><span class="n">alloc</span><span class="o">-</span><span class="n">fn</span><span class="o">=</span><span class="n">g_try_malloc</span> \
  <span class="o">--</span><span class="n">alloc</span><span class="o">-</span><span class="n">fn</span><span class="o">=</span><span class="n">g_malloc0</span> \
  <span class="o">--</span><span class="n">alloc</span><span class="o">-</span><span class="n">fn</span><span class="o">=</span><span class="n">g_mem_chunk_alloc</span> \
  <span class="n">swell</span><span class="o">-</span><span class="n">foop</span>
</pre></div>
</div>
<p><em>Swell Foop</em> is the program we will be using as an example. Be warned that,
since valgrind emulates the CPU, it will run very slowly. You will also need a
lot of memory.</p>
</section>
<section id="an-example-of-massif-guided-optimization">
<h2>An example of Massif-guided optimization<a class="headerlink" href="#an-example-of-massif-guided-optimization" title="Permalink to this heading">¶</a></h2>
<section id="interpreting-the-results">
<h3>Interpreting the Results<a class="headerlink" href="#interpreting-the-results" title="Permalink to this heading">¶</a></h3>
<p>The graphical output of Massif is largely self explanatory. Each band represents
the memory allocated by one function over time. Once you identify which bands
are using the most memory, usually the big thick ones at the top you will have
to consult the text file for the details.</p>
<p>The text file is arranged as a hierarchy of sections, at the top is a list of
the worst memory users arranged in order of decreasing spacetime. Below this are
further sections, each breaking the results down into finer detail as you
proceed down the call-stack. To illustrate this we will use the output of the
command above.</p>
<figure class="align-default" id="id1">
<img alt="../_images/massif-before.png" src="../_images/massif-before.png" />
<figcaption>
<p><span class="caption-text">Massif output for the unoptimized version of the Swell Foop program.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The image above shows a typical postscript output from Massif. This is the
result you would get from playing a single game of Swell Foop (version 2.8.0)
and then quitting. The postscript file will have a name like <code class="docutils literal notranslate"><span class="pre">massif.12345.ps</span></code>
and the text file will be called <code class="docutils literal notranslate"><span class="pre">massif.12345.txt</span></code>. The number in the middle
is the process ID of the program that was examined. If you actually try this
example you will find two versions of each file, with slightly different
numbers, this is because Swell Foop starts a second process and Massif follows
that too. We will ignore this second process, it consumes very little memory.</p>
<p>At the top of the graph we see a large yellow band labelled <code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code>.
This seems like an ideal candidate for optimization, but we will need to use the
text file to find out what is calling <code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code>. The top of the text
file will look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Command</span><span class="p">:</span> <span class="o">./</span><span class="n">swell</span><span class="o">-</span><span class="n">foop</span>

<span class="o">==</span> <span class="mi">0</span> <span class="o">===========================</span>
<span class="n">Heap</span> <span class="n">allocation</span> <span class="n">functions</span> <span class="n">accounted</span> <span class="k">for</span> <span class="mf">90.4</span><span class="o">%</span> <span class="n">of</span> <span class="n">measured</span> <span class="n">spacetime</span>

<span class="n">Called</span> <span class="n">from</span><span class="p">:</span>
  <span class="mf">28.8</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x6BF83A</span><span class="p">:</span> <span class="n">gdk_pixbuf_new</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgdk_pixbuf</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>

   <span class="mf">6.1</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x5A32A5</span><span class="p">:</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libglib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.6</span><span class="p">)</span>

   <span class="mf">5.9</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x510B3C</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libfreetype</span><span class="o">.</span><span class="n">so</span><span class="mf">.6.3.7</span><span class="p">)</span>

   <span class="mf">3.5</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x2A4A6B</span><span class="p">:</span> <span class="n">__gconv_open</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.3.3</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
</pre></div>
</div>
<p>The line with the ‘=’ signs indicates how far down the stack trace we are, in
this case we are at the top. After this it lists the heaviest users of memory in
order of decreasing spacetime. Spacetime is the product of the amount of memory
used and how long it was used for. It corresponds to the area of the bands in
the graph. This part of the file tells us what we already know: most of the
spacetime is dedicated to <code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code>. To find out what called
<code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code> we need to search further down the text file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="mi">4</span> <span class="o">===========================</span>
<span class="n">Context</span> <span class="n">accounted</span> <span class="k">for</span> <span class="mf">28.8</span><span class="o">%</span> <span class="n">of</span> <span class="n">measured</span> <span class="n">spacetime</span>
  <span class="mh">0x6BF83A</span><span class="p">:</span> <span class="n">gdk_pixbuf_new</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgdk_pixbuf</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>
  <span class="mh">0x3A998998</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gtk</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">2.4.0</span><span class="o">/</span><span class="n">loaders</span><span class="o">/</span><span class="n">libpixbufloader</span><span class="o">-</span><span class="n">png</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
  <span class="mh">0x6C2760</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgdk_pixbuf</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>
  <span class="mh">0x6C285E</span><span class="p">:</span> <span class="n">gdk_pixbuf_new_from_file</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgdk_pixbuf</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>

<span class="n">Called</span> <span class="n">from</span><span class="p">:</span>
  <span class="mf">27.8</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x804C1A3</span><span class="p">:</span> <span class="n">load_scenario</span> <span class="p">(</span><span class="n">swell</span><span class="o">-</span><span class="n">foop</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">463</span><span class="p">)</span>

   <span class="mf">0.9</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x3E8095E</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgnomeui</span><span class="o">-</span><span class="mf">2.</span><span class="n">so</span><span class="mf">.0.792.0</span><span class="p">)</span>

<span class="ow">and</span> <span class="mi">1</span> <span class="n">other</span> <span class="n">insignificant</span> <span class="n">place</span>
</pre></div>
</div>
<p>The first line tells us we are now four levels deep into the stack. Below it is
a listing of the function calls that leads from here to <code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code>.
Finally there is a list of functions that are at the next level down and call
these functions. There are, of course, also entries for levels 1, 2, and 3, but
this is the first level to reach right down through the GDK code to the Swell
Foop code. From this listing, we can see instantly that the problem code is
<code class="docutils literal notranslate"><span class="pre">load_scenario</span></code>.</p>
<p>Now that we know what part of our code is using all the spacetime we can look at
it and find out why. It turns out that the <code class="docutils literal notranslate"><span class="pre">load_scenario</span></code> is loading a pixbuf
from file and then never freeing that memory. Having identified the problem
code, we can start to fix it.</p>
</section>
<section id="acting-on-the-results">
<h3>Acting on the Results<a class="headerlink" href="#acting-on-the-results" title="Permalink to this heading">¶</a></h3>
<p>Reducing spacetime consumption is good, but there are two ways of reducing it
and they are not equal. You can either reduce the amount of memory allocated, or
reduce the amount of time it is allocated for. Consider for a moment a model
system with only two processes running. Both processes use up almost all the
physical RAM and if they overlap at all then the system will swap and everything
will slow down. Obviously if we reduce the memory usage of each process by a
factor of two then they can peacefully coexist without the need for swapping. If
instead we reduce the time the memory is allocated by a factor of two then the
two programs can coexist, but only as long as their periods of high memory use
don’t overlap. So it is better to reduce the amount of memory allocated.</p>
<p>Unfortunately, the choice of optimization is also constrained by the needs of
the program. The size of the pixbuf data in Swell Foop is determined by the size
of the game’s graphics and cannot be easily reduced. However, the amount of time
it spends loaded into memory can be drastically reduced. The image below shows
the Massif analysis of Swell Foop after being altered to dispose of the pixbufs
once the images have been loaded into the X server.</p>
<figure class="align-default" id="id2">
<img alt="../_images/massif-after.png" src="../_images/massif-after.png" />
<figcaption>
<p><span class="caption-text">Massif output for the optimized Swell Foop program.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The spacetime use of <code class="docutils literal notranslate"><span class="pre">gdk_pixbuf_new</span></code> is now a thin band that only spikes
briefly (it is now the sixteenth band down and shaded magenta). As a bonus, the
peak memory use has dropped by 200 kB since the spike occurs before other memory
is allocated. If two processes like this were run together the chances of the
peak memory usage coinciding, and hence the risk of swapping, would be quite
low.</p>
<p>Can we do better? A quick examination of Massif’s text output reveals:
<code class="docutils literal notranslate"><span class="pre">g_strdup</span></code> to be the new major offender.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Command</span><span class="p">:</span> <span class="o">./</span><span class="n">swell</span><span class="o">-</span><span class="n">foop</span>

<span class="o">==</span> <span class="mi">0</span> <span class="o">===========================</span>
<span class="n">Heap</span> <span class="n">allocation</span> <span class="n">functions</span> <span class="n">accounted</span> <span class="k">for</span> <span class="mf">87.6</span><span class="o">%</span> <span class="n">of</span> <span class="n">measured</span> <span class="n">spacetime</span>

<span class="n">Called</span> <span class="n">from</span><span class="p">:</span>
  <span class="mf">7.7</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x5A32A5</span><span class="p">:</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libglib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.6</span><span class="p">)</span>

  <span class="mf">7.6</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x43BC9F</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgdk</span><span class="o">-</span><span class="n">x11</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>

  <span class="mf">6.9</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x510B3C</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libfreetype</span><span class="o">.</span><span class="n">so</span><span class="mf">.6.3.7</span><span class="p">)</span>

  <span class="mf">5.2</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x2A4A6B</span><span class="p">:</span> <span class="n">__gconv_open</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.3.3</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
</pre></div>
</div>
<p>If we look closer though we see that it is called from many, many, places.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">==</span> <span class="mi">1</span> <span class="o">===========================</span>
<span class="n">Context</span> <span class="n">accounted</span> <span class="k">for</span>  <span class="mf">7.7</span><span class="o">%</span> <span class="n">of</span> <span class="n">measured</span> <span class="n">spacetime</span>
  <span class="mh">0x5A32A5</span><span class="p">:</span> <span class="n">g_strdup</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libglib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.6</span><span class="p">)</span>

<span class="n">Called</span> <span class="n">from</span><span class="p">:</span>
  <span class="mf">1.8</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x8BF606</span><span class="p">:</span> <span class="n">gtk_icon_source_copy</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgtk</span><span class="o">-</span><span class="n">x11</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>

  <span class="mf">1.1</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x67AF6B</span><span class="p">:</span> <span class="n">g_param_spec_internal</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgobject</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.6</span><span class="p">)</span>

  <span class="mf">0.9</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x91FCFC</span><span class="p">:</span> <span class="p">(</span><span class="n">within</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libgtk</span><span class="o">-</span><span class="n">x11</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.9</span><span class="p">)</span>

  <span class="mf">0.8</span><span class="o">%</span> <span class="p">:</span> <span class="mh">0x57EEBF</span><span class="p">:</span> <span class="n">g_quark_from_string</span> <span class="p">(</span><span class="ow">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libglib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="mf">.0.400.6</span><span class="p">)</span>

<span class="ow">and</span> <span class="mi">155</span> <span class="n">other</span> <span class="n">insignificant</span> <span class="n">places</span>
</pre></div>
</div>
<p>We now face diminishing returns for our optimization efforts. The graph hints at
another possible approach: Both the “other” and “heap admin” bands are quite
large. This tells us that there are a lot of small allocations being made from a
variety of places. Eliminating these will be difficult, but if they can be
grouped then the individual allocations can be larger and the “heap admin”
overhead can be reduced.</p>
</section>
</section>
<section id="caveats">
<h2>Caveats<a class="headerlink" href="#caveats" title="Permalink to this heading">¶</a></h2>
<p>There are a couple of things to watch out for: Firstly, spacetime is only
reported as a percentage, you have to compare it to the overall size of the
program to decide if the amount of memory is worth pursuing. The graph, with
its kilobyte vertical axis, is good for this.</p>
<p>Secondly, Massif only takes into account the memory used by your own program.
If your application uses IPC and references objects on different processes,
Massif won’t consider their memory footprint. In the Swell Foop example we have
actually only moved the memory consumption from client-side pixbufs to
server-side pixmaps. Even though we cheated there are performance gains:
keeping the image data in the X server makes the graphics routines quicker and
removes a lot of inter-process communication.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="sysprof.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Sysprof</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="valgrind.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Valgrind</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, GNUstep contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Massif</a><ul>
<li><a class="reference internal" href="#using-massif-with-gnome">Using Massif with GNOME</a></li>
<li><a class="reference internal" href="#an-example-of-massif-guided-optimization">An example of Massif-guided optimization</a><ul>
<li><a class="reference internal" href="#interpreting-the-results">Interpreting the Results</a></li>
<li><a class="reference internal" href="#acting-on-the-results">Acting on the Results</a></li>
</ul>
</li>
<li><a class="reference internal" href="#caveats">Caveats</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=359c27e9"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=4e2eecee"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    </body>
</html>